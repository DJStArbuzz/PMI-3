/* Лабораторная №3
Часть 1
Цель: изучить конструкции языка SQL для манипулирования данными в СУБД  MSSQL.
Задания и краткое описание работы:
*/
-- 1. Выборка из одной таблицы.

-- 1.1 Выбрать из произвольной таблицы данные и
--отсортировать их по двум  произвольным имеющимся в таблице признакам (разные направления сортировки).

SELECT id, full_name, street, house_number
FROM Patient
ORDER BY street ASC, house_number DESC;

-- 1.2 Выбрать из произвольной таблицы те записи, которые удовлетворяют
--условию отбора (where). Привести 2-3 запроса.

SELECT id, appeal_date, start_time, patient_id, visit_status
FROM Call
WHERE appeal_date BETWEEN '2024-01-01' AND '2024-01-20'
  AND visit_status = 1;

SELECT full_name, street, house_number, district_id
FROM Patient
WHERE district_id = 4;

SELECT full_name, street, house_number
FROM Patient
WHERE street = 'Улица Мира';


--1.3 Привести примеры 2-3 запросов с использованием агрегатных функций
--(count, max, sum и др.) с группировкой и без группировки. 

SELECT d.district_number, COUNT(p.id) as 'кол-во пациентов'
FROM District d
LEFT JOIN Patient p ON d.id = p.district_id
GROUP BY d.district_number;

SELECT street,
    MAX(house_number) as 'наибольший номер дома',
    MIN(house_number) as 'наименьший номер дома'
FROM Patient
GROUP BY street;

--1.4  Привести примеры подведения подытога с использованием GROUP BY [ALL] [ CUBE | ROLLUP](2-3 запроса). В ROLLUP и CUBE использовать не менее 2-х столбцов.

SELECT 
    appeal_date,
    visit_status,
    COUNT(*) as 'кол-во вызовов'
FROM Call
GROUP BY ROLLUP (appeal_date, visit_status)
ORDER BY appeal_date, visit_status;

SELECT 
    d.district_number as 'district_number',
    c.visit_status as 'visit_status',
    COUNT(c.id) as 'кол-во вызовов'
FROM Call c
JOIN Patient p ON c.patient_id = p.id
JOIN District d ON p.district_id = d.id
GROUP BY CUBE (d.district_number, c.visit_status)
ORDER BY d.district_number, c.visit_status;

--1.5 Выбрать из таблиц информацию об объектах, в названиях которых нет заданной последовательности букв (LIKE).

SELECT full_name
FROM Patient
WHERE full_name NOT LIKE '%ов%';

SELECT name
FROM Diagnosis
WHERE name NOT LIKE '%ит%';

